DECLARE
    current_balance numeric;
BEGIN
    -- Lock row
    SELECT wallet_balance INTO current_balance
    FROM users
    WHERE id = user_id
    FOR UPDATE;

    IF current_balance IS NULL THEN
        RAISE EXCEPTION 'User % not found', user_id;
    END IF;

    IF current_balance < amt THEN
        RETURN QUERY SELECT NULL::uuid, current_balance, 'INSUFFICIENT_FUNDS';
        RETURN;
    END IF;

    -- Deduct balance
    UPDATE users
    SET wallet_balance = wallet_balance - amt
    WHERE id = user_id;

    -- Insert transaction with whatever type is passed
    INSERT INTO transactions(user_id, type, amount, status, reference, description)
    VALUES(user_id, transaction_type, amt, 'pending', reference, description)
    RETURNING id INTO tx_id;

    RETURN QUERY SELECT tx_id, current_balance - amt, 'OK';
END;



  const txAmount = Number(pendingTx.amount ?? transactionAmount ?? 0);
  const nombaFee = Number(payload.data?.transaction?.fee || 0);

  // Use fee directly from transaction record
  const totalFees = Number(pendingTx.fee || 0);
  const appFee = Math.max(0, totalFees - nombaFee); // Ensure non-negative
  const totalDeduction = Number(pendingTx.total_deduction || txAmount + totalFees);

  console.log("ðŸ’° Transaction calculations:");
  console.log("   - Transaction amount:", txAmount);
  console.log("   - Total fee (from DB):", totalFees);
  console.log("   - Nomba fee (from webhook):", nombaFee);
  console.log("   - App fee (calculated):", appFee);
  console.log("   - Total deduction (from DB):", totalDeduction);
  console.log("   - Is P2P Transfer:", isP2PTransfer);